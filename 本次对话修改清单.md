# æœ¬æ¬¡å¯¹è¯ä¿®æ”¹æ¸…å• - å®Œæ•´æ€»ç»“

## âœ… å·²ç¡®è®¤ä¿å­˜çš„ä¿®æ”¹

### 1. éŸ³é¢‘æ ¼å¼æ”¹ä¸º MP3
**æ–‡ä»¶**: `app/admin/publish/page.tsx`
- âœ… æ ‡ç­¾ï¼šéŸ³é¢‘æ–‡ä»¶ï¼ˆM4Aï¼‰â†’ éŸ³é¢‘æ–‡ä»¶ï¼ˆMP3ï¼‰
- âœ… acceptï¼šaudio/mp4,audio/m4a,.m4a â†’ audio/mpeg,audio/mp3,.mp3
- âœ… æç¤ºæ–‡å­—ï¼šM4A â†’ MP3

### 2. AI æç¤ºè¯å‡çº§ï¼ˆå­¦ä¹ å¯¼å‘ç‰ˆï¼‰
**æ–‡ä»¶**: `app/api/ai-chat-secure/route.ts`
- âœ… æ ‡é¢˜ï¼šæç®€æ—¥å¸¸ç‰ˆ â†’ å­¦ä¹ å¯¼å‘ç‰ˆ
- âœ… å›å¤é•¿åº¦ï¼š15ä¸ªè¯ â†’ 20-40ä¸ªè¯
- âœ… è¯æ±‡å¤ç”¨ï¼š1-2ä¸ª â†’ 2-3ä¸ª
- âœ… æ–°å¢ï¼šå¼€æ”¾å¼é—®é¢˜å¼•å¯¼ï¼ˆWhatã€Howã€Whyã€Have you ever...ï¼‰
- âœ… æ–°å¢ï¼šåˆ›é€ å­¦ä¹ åœºæ™¯ï¼ˆæè¿°ã€è§£é‡Šã€æ¯”è¾ƒã€ç»™å»ºè®®ï¼‰

### 3. æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶æå‡
**æ–‡ä»¶**: `next.config.ts`
- âœ… bodySizeLimit: 2mb â†’ 100mb
- âœ… æ³¨é‡Šæ›´æ–°ï¼šæ”¯æŒä»»æ„å¤§å°çš„å­—å¹•å’Œè§†é¢‘æ–‡ä»¶

---

## âŒ éœ€è¦æ£€æŸ¥/é‡æ–°åº”ç”¨çš„ä¿®æ”¹

### 4. è®¢é˜…å¼¹çª—ç‚¹å‡»ç©ºç™½å¤„å…³é—­
**æ–‡ä»¶**: `components/SubscriptionModal.tsx`
**çŠ¶æ€**: âš ï¸ Git diff ä¸ºç©ºï¼Œå¯èƒ½æœªä¿å­˜

**åº”è¯¥ä¿®æ”¹çš„ä½ç½®**ï¼ˆçº¦ç¬¬ 200 è¡Œï¼‰ï¼š
```tsx
// åœ¨èƒŒæ™¯å±‚æ·»åŠ  onClick={onClose}
<motion.div
  onClick={onClose}  // â† æ·»åŠ è¿™è¡Œ
  className="fixed inset-0 z-[9999]..."
>
  <motion.div
    onClick={(e) => e.stopPropagation()}  // â† æ·»åŠ è¿™è¡Œï¼Œé˜²æ­¢ç‚¹å‡»å†…å®¹æ—¶å…³é—­
    className="relative w-full max-w-6xl..."
  >
```

### 5. é•¿å­—å¹•åˆ†å—å­˜å‚¨
**æ–‡ä»¶**: `app/api/publish/route.ts`
**çŠ¶æ€**: âš ï¸ éœ€è¦æ£€æŸ¥æ˜¯å¦åŒ…å«ä»¥ä¸‹ä¿®æ”¹

**åº”è¯¥åŒ…å«çš„ä»£ç **ï¼ˆçº¦ç¬¬ 197-210 è¡Œï¼‰ï¼š
```typescript
// æ·»åŠ  SRT åŸå§‹å†…å®¹ - åˆ†å—å­˜å‚¨ä»¥çªç ´ 2000 å­—ç¬¦é™åˆ¶
if (contentType === 'video' && srtFile) {
  const srtContent = await srtFile.text();
  const chunks = [];
  for (let i = 0; i < srtContent.length; i += 2000) {
    chunks.push({ text: { content: srtContent.substring(i, i + 2000) } });
  }
  notionProperties[NOTION_FIELDS.LESSON.SRT_RAW] = {
    rich_text: chunks
  };
}
```

**åº”è¯¥åŒ…å«çš„ä»£ç **ï¼ˆçº¦ç¬¬ 308-330 è¡Œï¼‰ï¼š
```typescript
// åˆ›å»ºå›è¯‘ - åˆ†å—å­˜å‚¨
if (DATABASES.recall && aiContent.recall.text_en && aiContent.recall.text_cn) {
  // ä¸­æ–‡æ ‡é¢˜åˆ†å—
  const textCnChunks = [];
  const textCn = aiContent.recall.text_cn;
  for (let i = 0; i < textCn.length; i += 2000) {
    textCnChunks.push({ text: { content: textCn.substring(i, i + 2000) } });
  }
  
  // è‹±æ–‡å†…å®¹åˆ†å—
  const textEnChunks = [];
  const textEn = aiContent.recall.text_en;
  for (let i = 0; i < textEn.length; i += 2000) {
    textEnChunks.push({ text: { content: textEn.substring(i, i + 2000) } });
  }
  
  promises.push(
    notion.pages.create({
      parent: { database_id: DATABASES.recall },
      properties: {
        [NOTION_FIELDS.RECALL.TEXT_CN]: {
          title: textCnChunks
        },
        [NOTION_FIELDS.RECALL.TEXT_EN]: {
          rich_text: textEnChunks
        },
        ...
      }
    })
  );
}
```

### 6. AI ç”Ÿæˆå†…å®¹éªŒè¯
**æ–‡ä»¶**: `app/api/publish/route.ts`
**çŠ¶æ€**: âš ï¸ éœ€è¦æ£€æŸ¥

**åº”è¯¥åŒ…å«çš„ä»£ç **ï¼ˆçº¦ç¬¬ 260-280 è¡Œï¼‰ï¼š
```typescript
// åˆ›å»ºè¯æ±‡ï¼ˆéªŒè¯æ•°æ®å®Œæ•´æ€§ï¼‰
if (DATABASES.vocabulary && aiContent.vocabulary.length > 0) {
  for (const vocab of aiContent.vocabulary) {
    const v = vocab as any;
    
    // éªŒè¯å¿…å¡«å­—æ®µï¼Œè·³è¿‡ä¸å®Œæ•´çš„æ•°æ®
    if (!v.word || !v.phonetic || !v.definition || !v.definition_cn || !v.example) {
      console.warn('è·³è¿‡ä¸å®Œæ•´çš„è¯æ±‡æ•°æ®:', v);
      continue;
    }
    
    promises.push(...);
  }
}
```

### 7. DeepSeek max_tokens é™åˆ¶
**æ–‡ä»¶**: `app/api/publish/route.ts`
**çŠ¶æ€**: âš ï¸ éœ€è¦æ£€æŸ¥

**åº”è¯¥æ˜¯**ï¼ˆçº¦ç¬¬ 450 è¡Œï¼‰ï¼š
```typescript
max_tokens: 8192,  // DeepSeek æœ€å¤§æ”¯æŒ 8192
```

### 8. Notion æ–‡æœ¬è¯»å–åˆå¹¶æ‰€æœ‰å—
**æ–‡ä»¶**: `lib/notion-client.ts`
**çŠ¶æ€**: âœ… å·²ç¡®è®¤ä¿å­˜

**å·²åŒ…å«çš„ä»£ç **ï¼ˆçº¦ç¬¬ 60-70 è¡Œï¼‰ï¼š
```typescript
function getPlainText(property: any): string {
  if (!property) return '';
  
  // å¤„ç† title ç±»å‹ï¼ˆåˆå¹¶æ‰€æœ‰æ–‡æœ¬å—ï¼‰
  if (property.type === 'title' && property.title) {
    return property.title.map((t: any) => t.plain_text).join('');
  }
  
  // å¤„ç† rich_text ç±»å‹ï¼ˆåˆå¹¶æ‰€æœ‰æ–‡æœ¬å—ï¼‰
  if (property.type === 'rich_text' && property.rich_text) {
    return property.rich_text.map((t: any) => t.plain_text).join('');
  }
  
  return '';
}
```

### 9. ModuleSalon æ˜¾ç¤ºä¼˜åŒ–
**æ–‡ä»¶**: `components/ModuleSalon.tsx`
**çŠ¶æ€**: âš ï¸ Git diff ä¸ºç©ºï¼Œå¯èƒ½æœªä¿å­˜

**åº”è¯¥ä¿®æ”¹çš„ä½ç½®**ï¼ˆçº¦ç¬¬ 730 è¡Œï¼‰ï¼š
```tsx
{hasAccess && dailyLimit !== Infinity && (
  <p className="text-[9px] uppercase tracking-widest opacity-40" style={{ color: theme.text }}>
    {hasReachedLimit 
      ? `å·²ç”¨å®Œæœ¬æœŸ ${dailyLimit} æ¬¡å¯¹è¯ â€¢ å‡çº§åˆ°æ°¸ä¹…ä¼šå‘˜å¯æ— é™å¯¹è¯` 
      : `å‰©ä½™ ${remainingChats}/${dailyLimit} æ¬¡å¯¹è¯ â€¢ æ°¸ä¹…ä¼šå‘˜å¯åˆ‡æ¢æ¨¡å¼`  // â† æ·»åŠ ååŠå¥
    }
  </p>
)}
```

### 10. å¼€å‘ç¯å¢ƒå®‰å…¨ä¿®å¤
**æ–‡ä»¶**: `app/api/ai-chat-secure/route.ts`
**çŠ¶æ€**: âš ï¸ éœ€è¦æ£€æŸ¥

**åº”è¯¥åŒ…å«çš„ä»£ç **ï¼ˆçº¦ç¬¬ 51-60 è¡Œï¼‰ï¼š
```typescript
// ğŸ”§ å¼€å‘ç¯å¢ƒï¼šå…è®¸é€šè¿‡ header æ¨¡æ‹Ÿä¼šå‘˜èº«ä»½
const devTier = req.headers.get('x-dev-tier');
const devSecret = req.headers.get('x-dev-secret');
const isDev = process.env.NODE_ENV === 'development';
const validDevSecret = process.env.DEV_SECRET || 'dev-only-secret-12345';

if (isDev && devTier && devSecret === validDevSecret) {
  console.log('ğŸ”§ Dev mode: Using simulated tier:', devTier);
  return {
    valid: true,
    tier: devTier,
    userId: 'dev_user_fixed',
    deviceId: 'dev_device'
  };
}
```

### 11. å‰ç«¯å‘é€å¼€å‘å¯†é’¥
**æ–‡ä»¶**: `components/ModuleSalon.tsx`
**çŠ¶æ€**: âš ï¸ éœ€è¦æ£€æŸ¥

**åº”è¯¥åŒ…å«çš„ä»£ç **ï¼ˆçº¦ç¬¬ 117ã€351 è¡Œï¼‰ï¼š
```typescript
// è·å–èŠå¤©æ¬¡æ•°æ—¶
const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
if (isDev && membershipType) {
  headers['x-dev-tier'] = membershipType;
  headers['x-dev-secret'] = 'dev-only-secret-12345';
}

// å‘é€æ¶ˆæ¯æ—¶
const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
if (isDev && membershipType) {
  headers['x-dev-tier'] = membershipType;
  headers['x-dev-secret'] = 'dev-only-secret-12345';
}
```

### 12. AI æ¨¡å¼å›¾æ ‡å’Œåç§°æ›´æ–°
**æ–‡ä»¶**: `components/ModuleSalon.tsx`
**çŠ¶æ€**: âš ï¸ éœ€è¦æ£€æŸ¥

**åº”è¯¥æ˜¯**ï¼ˆçº¦ç¬¬ 40-60 è¡Œï¼‰ï¼š
```typescript
const AI_MODES = {
  professional: {
    name: 'é è°±æ­æ¡£',
    icon: 'â˜•ï¸',
    // description å·²åˆ é™¤
  },
  arrogant: {
    name: 'æ¯’èˆŒè€å‹',
    icon: 'ğŸ¥',
    // description å·²åˆ é™¤
  },
  romantic: {
    name: 'æµªæ¼«æ—…ä¼´',
    icon: 'ğŸ¥‚',
    // description å·²åˆ é™¤
  }
};
```

### 13. æ¨¡å¼é€‰æ‹©å™¨å®½åº¦
**æ–‡ä»¶**: `components/ModuleSalon.tsx`
**çŠ¶æ€**: âš ï¸ éœ€è¦æ£€æŸ¥

**åº”è¯¥æ˜¯**ï¼ˆçº¦ç¬¬ 475 è¡Œï¼‰ï¼š
```tsx
<motion.div
  className="absolute right-0 top-full mt-2 rounded-xl border shadow-xl overflow-hidden z-30"
  style={{ 
    width: '150px',  // â† æ”¹ä¸º 150px
    backgroundColor: theme.background,
    borderColor: theme.lineColor
  }}
>
```

### 14. ç§»åŠ¨ç«¯å¯¼å‡ºåŠŸèƒ½ç¦ç”¨
**æ–‡ä»¶**: `app/[locale]/lesson/[id]/page.tsx`
**çŠ¶æ€**: âš ï¸ éœ€è¦æ£€æŸ¥

**åº”è¯¥æ³¨é‡Šæ‰**ï¼ˆçº¦ç¬¬ 900-950 è¡Œï¼‰ï¼š
```tsx
{/* å¯¼å‡ºæŒ‰é’® - ç§»åŠ¨ç«¯ - å·²ç¦ç”¨ï¼Œä»…æ¡Œé¢ç«¯å¯ç”¨ */}
{/* {lesson && ['script', 'vocab', 'grammar'].includes(activeTab) && (
  <Suspense fallback={null}>
    ...ç§»åŠ¨ç«¯å¯¼å‡ºæŒ‰é’®...
  </Suspense>
)} */}
```

### 15. é¦–é¡µé‚®ç®±åœ°å€
**æ–‡ä»¶**: `app/page.tsx`
**çŠ¶æ€**: âš ï¸ éœ€è¦æ£€æŸ¥

**åº”è¯¥æ˜¯**ï¼š
```tsx
<a
  href="mailto:aestheticenglish@outlook.com"
  className="text-[9px] tracking-[0.1em] text-[#2D0F15]/35 hover:text-[#2D0F15]/70 transition-colors"
>
  aestheticenglish@outlook.com
</a>
```

### 16. SubscriptionModal ç§»åŠ¨ç«¯ä¼˜åŒ–
**æ–‡ä»¶**: `components/SubscriptionModal.tsx`
**çŠ¶æ€**: âš ï¸ éœ€è¦æ£€æŸ¥

**åº”è¯¥åŒ…å«çš„ä¿®æ”¹**ï¼š
- åˆ é™¤ç§»åŠ¨ç«¯æ ‡é¢˜"ç¾å­¦è‹±è¯­ å‡­é‚€å…¥å†…"
- åˆ é™¤ç§»åŠ¨ç«¯èƒŒé¢çš„æœç´¢å›¾æ ‡å’Œ Return æŒ‰é’®
- èƒŒé¢æ ‡é¢˜æ”¹ä¸º"è¯šæŒšé‚€è¯·"ï¼ˆæ— æ–œä½“ï¼‰
- åˆ é™¤"æˆ‘ä»¬çš„å¯†é’¥ä»…é€šè¿‡..."æ–‡å­—ï¼ˆä»…ç§»åŠ¨ç«¯ï¼‰

---

## ğŸ” éªŒè¯æ–¹æ³•

### å¿«é€Ÿæ£€æŸ¥å‘½ä»¤ï¼š
```bash
# 1. æ£€æŸ¥ AI æç¤ºè¯æ˜¯å¦åŒ…å« "20-40"
grep -n "20-40" app/api/ai-chat-secure/route.ts

# 2. æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶æ˜¯å¦ä¸º 100mb
grep -n "100mb" next.config.ts

# 3. æ£€æŸ¥éŸ³é¢‘æ ¼å¼æ˜¯å¦ä¸º MP3
grep -n "audio/mpeg" app/admin/publish/page.tsx

# 4. æ£€æŸ¥æ˜¯å¦æœ‰åˆ†å—å­˜å‚¨ä»£ç 
grep -n "chunks.push" app/api/publish/route.ts

# 5. æ£€æŸ¥ max_tokens æ˜¯å¦ä¸º 8192
grep -n "max_tokens.*8192" app/api/publish/route.ts

# 6. æ£€æŸ¥ getPlainText æ˜¯å¦åˆå¹¶æ‰€æœ‰å—
grep -A 5 "getPlainText" lib/notion-client.ts | grep "join"

# 7. æ£€æŸ¥å¼€å‘å¯†é’¥éªŒè¯
grep -n "x-dev-secret" app/api/ai-chat-secure/route.ts

# 8. æ£€æŸ¥ AI æ¨¡å¼åç§°
grep -n "é è°±æ­æ¡£\|æ¯’èˆŒè€å‹\|æµªæ¼«æ—…ä¼´" components/ModuleSalon.tsx
```

---

## ğŸ“ å»ºè®®æ“ä½œ

1. **ç«‹å³è¿è¡ŒéªŒè¯å‘½ä»¤**ï¼Œç¡®è®¤å“ªäº›ä¿®æ”¹å·²ä¿å­˜
2. **å¯¹äºæœªä¿å­˜çš„ä¿®æ”¹**ï¼Œé€ä¸€é‡æ–°åº”ç”¨
3. **æµ‹è¯•å…³é”®åŠŸèƒ½**ï¼š
   - ä¸Šä¼ é•¿å­—å¹•è§†é¢‘ï¼ˆcognitive-02ï¼‰
   - éªŒè¯ AI å¯¹è¯ï¼ˆ20-40è¯å›å¤ï¼‰
   - æµ‹è¯•è®¢é˜…å¼¹çª—ï¼ˆç‚¹å‡»ç©ºç™½å…³é—­ï¼‰
   - æ£€æŸ¥æ°¸ä¹…ä¼šå‘˜æ— é™å¯¹è¯æ˜¾ç¤º

---

ç”Ÿæˆæ—¶é—´ï¼š2026-02-20
å¯¹è¯ IDï¼šæœ¬æ¬¡ä¼šè¯

