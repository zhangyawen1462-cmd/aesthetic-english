# ä»æ¨¡æ‹Ÿç³»ç»Ÿå‡çº§åˆ°çœŸå®ç³»ç»ŸæŒ‡å—

## ğŸ“Š å½“å‰çŠ¶æ€

ä½ çš„æƒé™ç³»ç»Ÿç›®å‰æ˜¯**å‰ç«¯æ¨¡æ‹Ÿç‰ˆæœ¬**ï¼š
- âœ… æ‰€æœ‰æƒé™é€»è¾‘å·²å®Œæˆ
- âœ… UI ç»„ä»¶å·²å®Œæˆ
- âœ… å¼€å‘è€…å·¥å…·å·²å®Œæˆ
- âŒ æ²¡æœ‰çœŸå®çš„ç”¨æˆ·æ•°æ®åº“
- âŒ æ²¡æœ‰æ”¯ä»˜ç³»ç»Ÿ

---

## ğŸ¯ å‡çº§è·¯å¾„

### é˜¶æ®µ 1ï¼šé›†æˆç”¨æˆ·è®¤è¯ï¼ˆ1-2 å¤©ï¼‰

#### é€‰é¡¹ Aï¼šSupabaseï¼ˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… å…è´¹é¢åº¦å……è¶³
- âœ… å†…ç½®ç”¨æˆ·è®¤è¯
- âœ… å®æ—¶æ•°æ®åº“
- âœ… ç®€å•æ˜“ç”¨

**æ­¥éª¤**ï¼š

1. **å®‰è£… Supabase**
```bash
npm install @supabase/supabase-js @supabase/auth-helpers-nextjs
```

2. **åˆ›å»º Supabase é¡¹ç›®**
- è®¿é—® https://supabase.com
- åˆ›å»ºæ–°é¡¹ç›®
- è·å– API å¯†é’¥

3. **é…ç½®ç¯å¢ƒå˜é‡**
```env
# .env.local
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

4. **åˆ›å»ºç”¨æˆ·è¡¨**
```sql
-- Supabase SQL Editor
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE NOT NULL,
  membership_tier TEXT DEFAULT 'quarterly',
  membership_expires_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);
```

5. **æ›´æ–° MembershipContext**
```typescript
// context/MembershipContext.tsx
import { useUser } from '@supabase/auth-helpers-react';

export function MembershipProvider({ children }) {
  const user = useUser();
  const [realTier, setRealTier] = useState<MembershipTier>(null);

  useEffect(() => {
    if (user) {
      // ä» Supabase è·å–çœŸå®ä¼šå‘˜æ•°æ®
      fetch(`/api/user/membership?userId=${user.id}`)
        .then(res => res.json())
        .then(data => setRealTier(data.tier));
    }
  }, [user]);

  // ... å…¶ä»–ä»£ç 
}
```

---

#### é€‰é¡¹ Bï¼šNextAuth.js

**ä¼˜åŠ¿**ï¼š
- âœ… æ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼ˆGoogle/GitHub/å¾®ä¿¡ï¼‰
- âœ… ä¸ Next.js æ·±åº¦é›†æˆ
- âœ… çµæ´»çš„æ•°æ®åº“é€‰æ‹©

**æ­¥éª¤**ï¼š

1. **å®‰è£… NextAuth**
```bash
npm install next-auth
```

2. **é…ç½® NextAuth**
```typescript
// app/api/auth/[...nextauth]/route.ts
import NextAuth from "next-auth";
import GoogleProvider from "next-auth/providers/google";

export const authOptions = {
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    }),
  ],
  callbacks: {
    async session({ session, token }) {
      // æ·»åŠ ä¼šå‘˜ä¿¡æ¯åˆ° session
      session.user.membershipTier = token.membershipTier;
      return session;
    },
  },
};

const handler = NextAuth(authOptions);
export { handler as GET, handler as POST };
```

---

### é˜¶æ®µ 2ï¼šé›†æˆæ”¯ä»˜ç³»ç»Ÿï¼ˆ2-3 å¤©ï¼‰

#### é€‰é¡¹ Aï¼šå¾®ä¿¡æ”¯ä»˜ + æ”¯ä»˜å®

**æ­¥éª¤**ï¼š

1. **ç”³è¯·å•†æˆ·å·**
- å¾®ä¿¡æ”¯ä»˜ï¼šhttps://pay.weixin.qq.com
- æ”¯ä»˜å®ï¼šhttps://open.alipay.com

2. **åˆ›å»ºæ”¯ä»˜ API**
```typescript
// app/api/payment/create/route.ts
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  const { tier, userId } = await request.json();
  
  // æ ¹æ®ä¼šå‘˜ç±»å‹ç¡®å®šä»·æ ¼
  const prices = {
    quarterly: 99,
    yearly: 299,
    lifetime: 999
  };
  
  // è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ API
  const order = await createWechatOrder({
    amount: prices[tier],
    description: `Aesthetic English - ${tier}`,
    userId
  });
  
  return NextResponse.json({ orderId: order.id, qrCode: order.qrCode });
}
```

3. **åˆ›å»ºæ”¯ä»˜å›è°ƒ**
```typescript
// app/api/payment/callback/route.ts
export async function POST(request: NextRequest) {
  // éªŒè¯æ”¯ä»˜ç­¾å
  const { orderId, status } = await verifyPayment(request);
  
  if (status === 'success') {
    // æ›´æ–°ç”¨æˆ·ä¼šå‘˜çŠ¶æ€
    await updateUserMembership(orderId);
  }
  
  return NextResponse.json({ success: true });
}
```

---

#### é€‰é¡¹ Bï¼šStripeï¼ˆå›½é™…æ”¯ä»˜ï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… ç®€å•æ˜“ç”¨
- âœ… æ”¯æŒä¿¡ç”¨å¡
- âœ… å®Œå–„çš„æ–‡æ¡£

**æ­¥éª¤**ï¼š

1. **å®‰è£… Stripe**
```bash
npm install stripe @stripe/stripe-js
```

2. **åˆ›å»ºæ”¯ä»˜ä¼šè¯**
```typescript
// app/api/payment/stripe/route.ts
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

export async function POST(request: NextRequest) {
  const { tier } = await request.json();
  
  const session = await stripe.checkout.sessions.create({
    payment_method_types: ['card'],
    line_items: [{
      price_data: {
        currency: 'cny',
        product_data: {
          name: `Aesthetic English - ${tier}`,
        },
        unit_amount: tier === 'quarterly' ? 9900 : tier === 'yearly' ? 29900 : 99900,
      },
      quantity: 1,
    }],
    mode: 'payment',
    success_url: `${process.env.NEXT_PUBLIC_URL}/success`,
    cancel_url: `${process.env.NEXT_PUBLIC_URL}/cancel`,
  });
  
  return NextResponse.json({ sessionId: session.id });
}
```

---

### é˜¶æ®µ 3ï¼šä¼šå‘˜åˆ°æœŸæ£€æŸ¥ï¼ˆ1 å¤©ï¼‰

**åˆ›å»ºå®šæ—¶ä»»åŠ¡**ï¼š

```typescript
// app/api/cron/check-membership/route.ts
export async function GET(request: NextRequest) {
  // éªŒè¯ Cron å¯†é’¥
  if (request.headers.get('Authorization') !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // æŸ¥è¯¢å³å°†åˆ°æœŸçš„ä¼šå‘˜
  const expiringUsers = await db.query(`
    SELECT * FROM users 
    WHERE membership_expires_at < NOW() + INTERVAL '7 days'
    AND membership_expires_at > NOW()
  `);
  
  // å‘é€åˆ°æœŸæé†’é‚®ä»¶
  for (const user of expiringUsers) {
    await sendExpiryEmail(user.email, user.membership_expires_at);
  }
  
  // é™çº§å·²è¿‡æœŸä¼šå‘˜
  await db.query(`
    UPDATE users 
    SET membership_tier = 'quarterly'
    WHERE membership_expires_at < NOW()
  `);
  
  return NextResponse.json({ success: true });
}
```

**é…ç½® Vercel Cron**ï¼š

```json
// vercel.json
{
  "crons": [{
    "path": "/api/cron/check-membership",
    "schedule": "0 0 * * *"
  }]
}
```

---

## ğŸ“‹ å®Œæ•´å‡çº§æ¸…å•

### ç¬¬ 1 å‘¨ï¼šç”¨æˆ·ç³»ç»Ÿ

- [ ] é€‰æ‹©è®¤è¯æ–¹æ¡ˆï¼ˆSupabase/NextAuthï¼‰
- [ ] åˆ›å»ºç”¨æˆ·æ•°æ®åº“è¡¨
- [ ] å®ç°æ³¨å†Œ/ç™»å½•é¡µé¢
- [ ] æ›´æ–° MembershipContext ä»æ•°æ®åº“è¯»å–
- [ ] æµ‹è¯•ç”¨æˆ·è®¤è¯æµç¨‹

### ç¬¬ 2 å‘¨ï¼šæ”¯ä»˜ç³»ç»Ÿ

- [ ] é€‰æ‹©æ”¯ä»˜æ–¹æ¡ˆï¼ˆå¾®ä¿¡/æ”¯ä»˜å®/Stripeï¼‰
- [ ] ç”³è¯·å•†æˆ·å·/API å¯†é’¥
- [ ] åˆ›å»ºæ”¯ä»˜ API è·¯ç”±
- [ ] å®ç°æ”¯ä»˜å›è°ƒå¤„ç†
- [ ] åˆ›å»ºè®¢é˜…é¡µé¢ UI
- [ ] æµ‹è¯•æ”¯ä»˜æµç¨‹

### ç¬¬ 3 å‘¨ï¼šä¼šå‘˜ç®¡ç†

- [ ] å®ç°ä¼šå‘˜åˆ°æœŸæ£€æŸ¥
- [ ] åˆ›å»ºä¼šå‘˜ä¸­å¿ƒé¡µé¢
- [ ] å®ç°ä¼šå‘˜ç»­è´¹åŠŸèƒ½
- [ ] æ·»åŠ é‚®ä»¶é€šçŸ¥
- [ ] æµ‹è¯•å®Œæ•´æµç¨‹

---

## ğŸ¯ æœ€å°å¯è¡Œäº§å“ï¼ˆMVPï¼‰

å¦‚æœä½ æƒ³å¿«é€Ÿä¸Šçº¿ï¼Œå¯ä»¥å…ˆå®ç°ï¼š

### é˜¶æ®µ 1ï¼šæ‰‹åŠ¨ç®¡ç†ï¼ˆ1 å¤©ï¼‰

1. **åˆ›å»ºç®€å•çš„åå°ç®¡ç†é¡µé¢**
```typescript
// app/admin/users/page.tsx
export default function AdminUsers() {
  const [users, setUsers] = useState([]);
  
  const updateMembership = async (userId, tier) => {
    await fetch('/api/admin/update-membership', {
      method: 'POST',
      body: JSON.stringify({ userId, tier })
    });
  };
  
  return (
    <div>
      {users.map(user => (
        <div key={user.id}>
          <span>{user.email}</span>
          <select onChange={(e) => updateMembership(user.id, e.target.value)}>
            <option value="quarterly">å­£åº¦ä¼šå‘˜</option>
            <option value="yearly">å¹´åº¦ä¼šå‘˜</option>
            <option value="lifetime">æ°¸ä¹…ä¼šå‘˜</option>
          </select>
        </div>
      ))}
    </div>
  );
}
```

2. **ç”¨æˆ·é€šè¿‡å¾®ä¿¡/æ”¯ä»˜å®è½¬è´¦**
3. **ä½ æ‰‹åŠ¨åœ¨åå°æ›´æ–°ä¼šå‘˜çŠ¶æ€**
4. **ç”¨æˆ·åˆ·æ–°é¡µé¢çœ‹åˆ°æ–°æƒé™**

**ä¼˜åŠ¿**ï¼š
- âœ… 1 å¤©å°±èƒ½ä¸Šçº¿
- âœ… ä¸éœ€è¦å¤æ‚çš„æ”¯ä»˜é›†æˆ
- âœ… é€‚åˆæ—©æœŸç”¨æˆ·

**åŠ£åŠ¿**ï¼š
- âŒ éœ€è¦æ‰‹åŠ¨å¤„ç†
- âŒ ä¸èƒ½è‡ªåŠ¨åŒ–
- âŒ ä¸é€‚åˆå¤§è§„æ¨¡

---

## ğŸ’¡ æˆ‘çš„å»ºè®®

### å¦‚æœä½ ç°åœ¨å°±æƒ³ä¸Šçº¿

**ä½¿ç”¨ MVP æ–¹æ¡ˆ**ï¼š
1. é›†æˆ Supabase ç”¨æˆ·è®¤è¯ï¼ˆ1 å¤©ï¼‰
2. åˆ›å»ºç®€å•çš„åå°ç®¡ç†é¡µé¢ï¼ˆ1 å¤©ï¼‰
3. ç”¨æˆ·é€šè¿‡å¾®ä¿¡è½¬è´¦è´­ä¹°
4. ä½ æ‰‹åŠ¨æ›´æ–°ä¼šå‘˜çŠ¶æ€
5. å…ˆç§¯ç´¯ 10-50 ä¸ªä»˜è´¹ç”¨æˆ·

### å¦‚æœä½ æƒ³åšå¾—æ›´ä¸“ä¸š

**å®Œæ•´æ–¹æ¡ˆ**ï¼š
1. ç¬¬ 1 å‘¨ï¼šSupabase + NextAuth
2. ç¬¬ 2 å‘¨ï¼šå¾®ä¿¡æ”¯ä»˜ + æ”¯ä»˜å®
3. ç¬¬ 3 å‘¨ï¼šä¼šå‘˜ç®¡ç† + é‚®ä»¶é€šçŸ¥
4. ç¬¬ 4 å‘¨ï¼šæµ‹è¯• + ä¼˜åŒ–

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

ä½ æƒ³é€‰æ‹©å“ªä¸ªæ–¹æ¡ˆï¼Ÿ

1. **MVP æ–¹æ¡ˆ**ï¼ˆå¿«é€Ÿä¸Šçº¿ï¼Œæ‰‹åŠ¨ç®¡ç†ï¼‰
2. **å®Œæ•´æ–¹æ¡ˆ**ï¼ˆä¸“ä¸šç³»ç»Ÿï¼Œè‡ªåŠ¨åŒ–ï¼‰
3. **å…ˆçœ‹çœ‹**ï¼ˆç»§ç»­å®Œå–„å‰ç«¯åŠŸèƒ½ï¼‰

å‘Šè¯‰æˆ‘ä½ çš„é€‰æ‹©ï¼Œæˆ‘å¯ä»¥å¸®ä½ å®ç°ï¼







