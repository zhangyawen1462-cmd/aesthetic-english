# ğŸ¨ å‰ç«¯é›†æˆæŒ‡å—

## ğŸ“ æ›´æ–° ModuleSalon.tsx

### 1. ç§»é™¤æ—§çš„ localStorage é€»è¾‘

åˆ é™¤ä»¥ä¸‹ä»£ç ï¼š

```typescript
// âŒ åˆ é™¤è¿™äº›
const [chatCount, setChatCount] = useState<number>(() => {
  if (typeof window !== 'undefined') {
    const storageKey = `gabby_chat_count_${lessonId}`;
    const saved = localStorage.getItem(storageKey);
    return saved ? parseInt(saved, 10) : 0;
  }
  return 0;
});

// âŒ åˆ é™¤ localStorage æ›´æ–°é€»è¾‘
if (dailyLimit !== Infinity) {
  const newCount = chatCount + 1;
  setChatCount(newCount);
  const storageKey = `gabby_chat_count_${lessonId}`;
  localStorage.setItem(storageKey, newCount.toString());
}
```

### 2. æ·»åŠ æ–°çš„çŠ¶æ€ç®¡ç†

åœ¨ `ModuleSalon.tsx` é¡¶éƒ¨æ·»åŠ ï¼š

```typescript
import WineCurtain from '@/components/WineCurtain';

// åœ¨ç»„ä»¶å†…éƒ¨æ·»åŠ çŠ¶æ€
const [chatCount, setChatCount] = useState<number>(0);
const [dailyLimit, setDailyLimit] = useState<number>(15);
const [showPaywall, setShowPaywall] = useState(false);
const [paywallMessage, setPaywallMessage] = useState('');
const [paywallRequiredTier, setPaywallRequiredTier] = useState<'yearly' | 'lifetime'>('lifetime');
```

### 3. ä»åç«¯è·å–å¯¹è¯æ¬¡æ•°

```typescript
// åœ¨ useEffect ä¸­è·å–å¯¹è¯æ¬¡æ•°
useEffect(() => {
  async function fetchChatUsage() {
    try {
      const response = await fetch(`/api/chat-usage/${lessonId}`);
      const data = await response.json();
      
      if (data.success) {
        setChatCount(data.data.chatCount);
        setDailyLimit(data.data.limit);
      }
    } catch (error) {
      console.error('Failed to fetch chat usage:', error);
    }
  }
  
  if (hasAccess) {
    fetchChatUsage();
  }
}, [lessonId, hasAccess]);
```

### 4. æ›´æ–° handleSend å‡½æ•°

```typescript
const handleSend = async () => {
  if (!input.trim() || isLoading) return;

  const userMessage: Message = {
    id: Date.now().toString(),
    role: "user",
    content: input.trim(),
    timestamp: new Date(),
  };

  setMessages((prev) => [...prev, userMessage]);
  setInput("");
  setIsLoading(true);

  // å­£åº¦ä¼šå‘˜çš„"å¹½çµè¾“å…¥"é€»è¾‘ä¿æŒä¸å˜
  if (!hasAccess) {
    setTimeout(() => {
      setIsLoading(false);
      const blurredMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: "assistant",
        content: "That is an interesting perspective. However, in a professional context...",
        timestamp: new Date(),
        isBlurred: true,
      };
      setMessages((prev) => [...prev, blurredMessage]);
    }, 1500);
    return;
  }

  // âœ… æ–°çš„åç«¯éªŒè¯é€»è¾‘
  try {
    const response = await fetch("/api/ai-chat-secure", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: input.trim(),
        mode: currentMode,
        lessonId: lessonId,
        videoContext: {
          title: videoContext.titleEn,
          titleCn: videoContext.titleCn,
          transcript: videoContext.transcript,
          vocabulary: videoContext.vocab,
        },
        conversationHistory: messages
          .filter(m => !m.isBlurred)
          .map((m) => ({
            role: m.role,
            content: m.content,
          })),
      }),
    });

    const data = await response.json();

    if (data.success) {
      // âœ… æˆåŠŸï¼šæ›´æ–°å¯¹è¯æ¬¡æ•°
      if (data.remainingChats !== undefined && data.remainingChats !== Infinity) {
        setChatCount(dailyLimit - data.remainingChats);
      }

      const aiMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: "assistant",
        content: data.reply,
        contentCn: data.replyCn,
        timestamp: new Date(),
        correction: data.correction || undefined,
      };
      setMessages((prev) => [...prev, aiMessage]);
    } else {
      // âŒ å¤±è´¥ï¼šå¤„ç†ä»˜è´¹å¢™
      if (data.error === 'paywall_limit_reached') {
        // ğŸ­ è§¦å‘æ·±é…’çº¢å¸·å¹•
        setShowPaywall(true);
        setPaywallMessage(data.message);
        setPaywallRequiredTier('lifetime');
      } else if (data.error === 'paywall_preview') {
        setShowPaywall(true);
        setPaywallMessage(data.message);
        setPaywallRequiredTier('yearly');
      } else if (data.error === 'unauthorized') {
        // æœªç™»å½•/æœªæ¿€æ´»ä¼šå‘˜
        alert('è¯·å…ˆæ¿€æ´»ä¼šå‘˜');
        window.location.href = '/pricing';
      } else {
        throw new Error(data.message);
      }
    }
  } catch (error) {
    console.error('Chat error:', error);
    setMessages((prev) => [...prev, {
      id: Date.now().toString(),
      role: 'assistant',
      content: "I seem to be having trouble connecting. Please try again.",
      timestamp: new Date()
    }]);
  } finally {
    setIsLoading(false);
  }
};
```

### 5. åœ¨ JSX ä¸­æ·»åŠ  WineCurtain

åœ¨ `return` è¯­å¥çš„æœ€å¤–å±‚ `div` å†…æ·»åŠ ï¼š

```typescript
return (
  <div className="w-full h-full flex flex-col relative overflow-hidden font-sans" style={getBackgroundStyle()}>
    
    {/* ç°æœ‰çš„ Headerã€Chat Areaã€Input Area... */}
    
    {/* ğŸ­ æ·±é…’çº¢å¸·å¹• */}
    <WineCurtain
      isVisible={showPaywall}
      onClose={() => setShowPaywall(false)}
      message={paywallMessage}
      requiredTier={paywallRequiredTier}
      currentTier={membershipType}
    />
  </div>
);
```

### 6. æ›´æ–°åº•éƒ¨æç¤ºæ–‡æ¡ˆ

```typescript
{/* åº•éƒ¨æç¤º */}
<div className="mt-2 text-center">
  {!hasAccess && (
    <p className="text-[9px] uppercase tracking-widest opacity-40" style={{ color: theme.text }}>
      Preview Mode â€¢ Upgrade to Yearly for full access
    </p>
  )}
  {hasAccess && dailyLimit !== Infinity && (
    <p className="text-[9px] uppercase tracking-widest opacity-40" style={{ color: theme.text }}>
      {chatCount >= dailyLimit 
        ? `å·²ç”¨å®Œæœ¬æœŸ ${dailyLimit} æ¬¡å¯¹è¯ â€¢ å‡çº§åˆ°æ°¸ä¹…ä¼šå‘˜å¯æ— é™å¯¹è¯` 
        : `å‰©ä½™ ${dailyLimit - chatCount}/${dailyLimit} æ¬¡å¯¹è¯`
      }
    </p>
  )}
  {hasAccess && dailyLimit === Infinity && (
    <p className="text-[9px] uppercase tracking-widest opacity-40" style={{ color: theme.text }}>
      âˆ æ— é™å¯¹è¯
    </p>
  )}
</div>
```

---

## ğŸ« åˆ›å»ºå…‘æ¢ç æ¿€æ´»é¡µé¢

æ–‡ä»¶ï¼š`app/redeem/page.tsx`

```typescript
"use client";

import React, { useState } from 'react';
import { motion } from 'framer-motion';
import { Sparkles, ArrowRight } from 'lucide-react';

export default function RedeemPage() {
  const [code, setCode] = useState('');
  const [email, setEmail] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [isSuccess, setIsSuccess] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setMessage('');

    try {
      const response = await fetch('/api/redeem', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code, email })
      });

      const data = await response.json();

      if (data.success) {
        setIsSuccess(true);
        setMessage(`å…‘æ¢æˆåŠŸï¼æ‚¨å·²æˆä¸º ${data.data.tierLabel}`);
        
        // 3ç§’åè·³è½¬åˆ°é¦–é¡µ
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 3000);
      } else {
        setIsSuccess(false);
        setMessage(data.message || 'å…‘æ¢å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } catch (error) {
      setIsSuccess(false);
      setMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen w-full bg-[#2D0F15] flex items-center justify-center p-4">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        className="max-w-md w-full p-8 rounded-2xl"
        style={{
          backgroundColor: 'rgba(255, 255, 255, 0.05)',
          border: '1px solid rgba(255, 255, 255, 0.1)',
          boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
        }}
      >
        {/* æ ‡é¢˜ */}
        <div className="text-center mb-8">
          <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-[#D4AF37] to-[#F4E5B8] flex items-center justify-center">
            <Sparkles size={32} className="text-white" />
          </div>
          <h1 className="text-2xl font-serif text-white mb-2">æ¿€æ´»ä¼šå‘˜</h1>
          <p className="text-white/60 text-sm">è¾“å…¥å…‘æ¢ç è§£é”å®Œæ•´ä½“éªŒ</p>
        </div>

        {/* è¡¨å• */}
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-white/80 text-sm mb-2">å…‘æ¢ç </label>
            <input
              type="text"
              value={code}
              onChange={(e) => setCode(e.target.value.toUpperCase())}
              placeholder="AE-LIFE-001-XXXX"
              className="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:border-[#D4AF37] transition-colors"
              required
            />
          </div>

          <div>
            <label className="block text-white/80 text-sm mb-2">é‚®ç®±</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="your@email.com"
              className="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:border-[#D4AF37] transition-colors"
              required
            />
          </div>

          {/* æç¤ºæ¶ˆæ¯ */}
          {message && (
            <motion.div
              initial={{ opacity: 0, y: -10 }}
              animate={{ opacity: 1, y: 0 }}
              className={`p-3 rounded-lg text-sm ${
                isSuccess 
                  ? 'bg-green-500/20 text-green-300 border border-green-500/30' 
                  : 'bg-red-500/20 text-red-300 border border-red-500/30'
              }`}
            >
              {message}
            </motion.div>
          )}

          {/* æäº¤æŒ‰é’® */}
          <motion.button
            type="submit"
            disabled={isLoading}
            whileHover={{ scale: 1.02 }}
            whileTap={{ scale: 0.98 }}
            className="w-full py-3.5 px-6 rounded-xl text-white font-medium flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            style={{
              background: 'linear-gradient(135deg, #D4AF37 0%, #F4E5B8 100%)',
              boxShadow: '0 4px 20px rgba(212, 175, 55, 0.4)',
            }}
          >
            {isLoading ? (
              <>
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                éªŒè¯ä¸­...
              </>
            ) : (
              <>
                æ¿€æ´»ä¼šå‘˜
                <ArrowRight size={18} />
              </>
            )}
          </motion.button>
        </form>

        {/* åº•éƒ¨é“¾æ¥ */}
        <div className="mt-6 text-center">
          <a 
            href="/pricing" 
            className="text-white/60 hover:text-white/80 text-sm transition-colors"
          >
            è¿˜æ²¡æœ‰å…‘æ¢ç ï¼ŸæŸ¥çœ‹ä¼šå‘˜æ–¹æ¡ˆ
          </a>
        </div>
      </motion.div>
    </div>
  );
}
```

---

## ğŸ”„ æ›´æ–° MembershipContext

æ–‡ä»¶ï¼š`context/MembershipContext.tsx`

æ·»åŠ ä»åç«¯è·å–ä¼šå‘˜çŠ¶æ€çš„é€»è¾‘ï¼š

```typescript
export function MembershipProvider({ children }: { children: ReactNode }) {
  const [realTier, setRealTier] = useState<MembershipTier>(null);
  const [devTier, setDevTierState] = useState<MembershipTier>(null);
  const [isLoading, setIsLoading] = useState(true);

  // ä»åç«¯è·å–çœŸå®ä¼šå‘˜çŠ¶æ€
  useEffect(() => {
    async function fetchMembership() {
      try {
        const response = await fetch('/api/membership');
        const data = await response.json();
        
        if (data.success && data.data.isAuthenticated) {
          setRealTier(data.data.tier);
        }
      } catch (error) {
        console.error('Failed to fetch membership:', error);
      } finally {
        setIsLoading(false);
      }
    }

    fetchMembership();

    // å¼€å‘ç¯å¢ƒï¼šè¯»å– dev_tier_override
    if (process.env.NODE_ENV === 'development') {
      const savedDevTier = localStorage.getItem('dev_tier_override') as MembershipTier;
      if (savedDevTier) {
        setDevTierState(savedDevTier);
      }
    }
  }, []);

  // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜
}
```

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] å®‰è£…ä¾èµ–åŒ…ï¼š`npm install @notionhq/client jose @vercel/kv`
- [ ] é…ç½® `.env.local` ç¯å¢ƒå˜é‡
- [ ] åœ¨ Notion ä¸­åˆ›å»ºå…‘æ¢ç æ•°æ®åº“å¹¶å…±äº«ç»™ Integration
- [ ] åˆ›å»º `lib/notion-redemption.ts`
- [ ] åˆ›å»º `app/api/redeem/route.ts`
- [ ] åˆ›å»º `app/api/ai-chat-secure/route.ts`
- [ ] åˆ›å»º `app/api/membership/route.ts`
- [ ] åˆ›å»º `app/api/chat-usage/[lessonId]/route.ts`
- [ ] åˆ›å»º `components/WineCurtain.tsx`
- [ ] æ›´æ–° `components/ModuleSalon.tsx`
- [ ] åˆ›å»º `app/redeem/page.tsx`
- [ ] æ›´æ–° `context/MembershipContext.tsx`
- [ ] æµ‹è¯•å…‘æ¢ç æ¿€æ´»æµç¨‹
- [ ] æµ‹è¯• AI å¯¹è¯æ¬¡æ•°é™åˆ¶
- [ ] æµ‹è¯•æ·±é…’çº¢å¸·å¹•æ˜¾ç¤º

---

## ğŸ§ª æµ‹è¯•æµç¨‹

1. **ç”Ÿæˆæµ‹è¯•å…‘æ¢ç **ï¼š
   - åœ¨ Notion æ•°æ®åº“ä¸­æ‰‹åŠ¨æ·»åŠ ä¸€æ¡è®°å½•
   - Code: `AE-TEST-001-ABCD`
   - Type: `å¹´åº¦ä¼šå‘˜`
   - Status: `ğŸ†• å¾…å”®`

2. **æµ‹è¯•æ¿€æ´»**ï¼š
   - è®¿é—® `/redeem`
   - è¾“å…¥å…‘æ¢ç å’Œé‚®ç®±
   - ç‚¹å‡»æ¿€æ´»

3. **éªŒè¯ä¼šå‘˜çŠ¶æ€**ï¼š
   - æ‰“å¼€æµè§ˆå™¨ DevTools â†’ Application â†’ Cookies
   - æŸ¥çœ‹ `ae_membership` Cookie æ˜¯å¦å­˜åœ¨

4. **æµ‹è¯•å¯¹è¯é™åˆ¶**ï¼š
   - è¿›å…¥ä»»æ„è¯¾ç¨‹çš„ SALON æ¨¡å—
   - å‘é€ 15 æ¡æ¶ˆæ¯
   - ç¬¬ 16 æ¡åº”è¯¥è§¦å‘æ·±é…’çº¢å¸·å¹•

å®Œæˆï¼ğŸ‰






