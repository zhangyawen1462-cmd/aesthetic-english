# 会员体系完整指南

> 从零到一搭建一个安全、优雅、易维护的会员权限系统

---

## 📖 目录

1. [系统概览](#系统概览)
2. [会员权益对比](#会员权益对比)
3. [六大核心模块](#六大核心模块)
4. [快速上手](#快速上手)
5. [常见问题](#常见问题)

---

## 系统概览

### 🎯 设计目标

- **安全可靠**：前端 + 后端双重验证，防止绕过
- **易于维护**：单一数据源，改一处全站生效
- **开发友好**：开发者模式，一键切换会员测试
- **用户体验**：优雅降级，FOMO 转化策略

### 🏗️ 架构图

```
┌─────────────────────────────────────────────────────────┐
│                      会员权限系统                         │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  📜 权限宪法 (lib/permissions.ts)                        │
│  └─ 所有权限规则的单一数据源                             │
│                                                           │
│  🪄 开发者面板 (components/DevPanel.tsx)                 │
│  └─ 本地开发时一键切换会员类型                           │
│                                                           │
│  🎭 门禁组件 (components/ContentGate.tsx)                │
│  └─ 磨砂玻璃遮罩，优雅锁定内容                           │
│                                                           │
│  🔐 安全下载 API (app/api/download/route.ts)             │
│  └─ 后端验证 + OSS 签名 URL                              │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

---

## 会员权益对比

### 📊 完整权限矩阵

| 功能 | 季度会员（访客） | 年度会员（住民） | 永久会员（赞助人） |
|------|----------------|----------------|------------------|
| **Daily 课程** | ✅ 全解锁<br/>轻松看，随便学 | ✅ 全解锁<br/>+ 导出笔记 | 🔥 全解锁<br/>+ 下载原片 + 笔记导出 |
| **Cognitive 课程** | ⚠️ 限制访问<br/>只能看精选页 1 期<br/>（这是钩子） | ✅ 全解锁<br/>+ 导出笔记 | 🔥 全解锁<br/>+ 下载原片 + 笔记导出 |
| **Business 课程** | 🔒 完全锁定<br/>显示磨砂玻璃遮罩<br/>（这是墙） | ✅ 全解锁<br/>+ 导出笔记 | 🔥 全解锁<br/>+ 下载原片 + 笔记导出 |
| **Gabby AI 对话** | ❌ 不可用<br/>只能看开场白 | ✅ 有限使用<br/>每期视频 15 次对话 | 🔥 无限畅聊<br/>+ 三种人格模式 |
| **笔记导出** | ❌ | ✅ 双语字幕/语法/词汇 | ✅ 双语字幕/语法/词汇 |
| **原始视频下载** | ❌ | ❌ | ✅ 高清原片 + 音频 |

### 💰 定价策略

| 会员类型 | 价格 | 时长 | 定位 |
|---------|------|------|------|
| 季度会员 | ¥99 | 3个月 | 访客 - 体验基础功能 |
| 年度会员 | ¥299 | 12个月 | 住民 - 完整学习体验 |
| 永久会员 | ¥999 | 终身 | 赞助人 - 尊享所有权益 |

---

## 六大核心模块

### 1️⃣ 权限宪法 - 单一数据源

**文件**：`lib/permissions.ts`

**作用**：所有权限规则集中管理，避免代码重复

#### 为什么需要？

❌ **之前的问题**：
```typescript
// 文件 A
if (tier === '年度会员' || tier === '永久会员')

// 文件 B
if (tier !== '季度会员')

// 文件 C
if (['年度会员', '永久会员'].includes(tier))
```
→ 同样的逻辑写了 N 遍，改规则要改 N 个文件

✅ **现在的解决方案**：
```typescript
// lib/permissions.ts（只改这一个文件）
export const PERMISSIONS = {
  aiChat: {
    canAccess: (tier) => tier === '年度会员' || tier === '永久会员'
  }
};

// 所有组件都调用这个函数
const hasAccess = PERMISSIONS.aiChat.canAccess(membershipType);
```
→ 改一处，全站生效！

#### 使用示例

```typescript
import { PERMISSIONS, canAccessCourse } from '@/lib/permissions';

// 检查课程访问权限
const canViewBusiness = canAccessCourse('business', membershipType);

// 检查 AI 对话权限
const canUseAI = PERMISSIONS.aiChat.canAccess(membershipType);

// 获取 AI 对话次数限制
const limit = PERMISSIONS.aiChat.getLimit(membershipType);
// 季度会员: 0, 年度会员: 15, 永久会员: 999
```

---

### 2️⃣ 开发者面板 - 上帝模式

**文件**：`components/DevPanel.tsx`

**作用**：本地开发时一键切换会员类型，快速测试

#### 为什么需要？

测试不同会员看到的界面，传统方式：
1. 去数据库改数据 ❌
2. 退出登录换账号 ❌
3. 重新激活兑换码 ❌

→ 太慢了！

#### 使用方法

1. 本地运行 `npm run dev`
2. 右下角出现黑色圆形按钮（眼睛图标）
3. 点击 → 输入密码 `456852`
4. 选择会员类型 → 页面自动刷新

#### 特性

- ✅ **只在本地显示**（生产环境自动隐藏）
- ✅ **密码保护**（456852）
- ✅ **一键切换**（4 种状态：未登录/季度/年度/永久）
- ✅ **自动刷新**（切换后立即生效）

#### 安全机制

```typescript
// 只在开发环境显示
if (process.env.NODE_ENV !== 'development') {
  return null; // 生产环境完全不渲染
}
```

---

### 3️⃣ 门禁组件 - 磨砂玻璃遮罩

**文件**：`components/ContentGate.tsx`

**作用**：通用的权限锁定组件，优雅降级

#### 为什么需要？

❌ **之前的问题**：
```typescript
// 每个页面都手动写遮罩代码
<div className="blur-md"><Content /></div>
<div className="absolute inset-0 backdrop-blur-xl">
  <Lock />
  <p>需要升级</p>
</div>
```
→ 代码重复，风格不统一

✅ **现在的解决方案**：
```typescript
// 一行代码搞定
<ContentGate 
  requiredTier="annual" 
  currentTier={membershipType}
  feature="Business 课程"
>
  <YourContent />
</ContentGate>
```

#### 使用示例

**示例 1：锁定 Business 课程**
```typescript
<ContentGate
  requiredTier="annual"
  currentTier={membershipType}
  feature="Business 课程"
  variant="blur"
  accentColor="#8b5cf6"
>
  <BusinessCourseContent />
</ContentGate>
```

**示例 2：锁定下载功能**
```typescript
<ContentGate
  requiredTier="lifetime"
  currentTier={membershipType}
  feature="原始视频下载"
>
  <DownloadButton />
</ContentGate>
```

#### 视觉效果

- 🎨 磨砂玻璃背景
- 🔒 呼吸动画锁图标
- 💬 清晰的升级提示
- 🎯 一键跳转订阅页面

---

### 4️⃣ FOMO 转化策略

**心理学原理**：Fear Of Missing Out（害怕错过）

#### 错误做法 ❌

季度会员点进 Business 课程 → 404 或空白页
→ 用户以为走错了，直接离开

#### 正确做法 ✅

让用户看到：
- ✅ 页面标题和描述
- ✅ 视频播放器（但被锁住）
- ✅ 课程大纲和介绍

→ 用户知道"原本可以得到什么"，产生升级冲动

#### 实现方式

```typescript
export default function CourseDetailPage() {
  const membershipType = getMembershipType();
  const canAccess = canAccessCourse('business', membershipType);

  return (
    <div>
      {/* 标题：所有人都能看到（钩子） */}
      <h1>{lesson.title}</h1>
      <p>{lesson.description}</p>

      {/* 视频：根据权限显示或锁定 */}
      {canAccess ? (
        <VideoPlayer src={lesson.videoUrl} />
      ) : (
        <ContentGate
          requiredTier="annual"
          currentTier={membershipType}
          feature="Business 课程"
        >
          <VideoPlayer src={lesson.videoUrl} />
        </ContentGate>
      )}
    </div>
  );
}
```

---

### 5️⃣ AI 对话限制 - 成本控制

**文件**：`components/ModuleSalon.tsx`

**作用**：防止 AI Token 成本爆炸，分级限制使用

#### 为什么需要？

AI Token 要花钱！如果季度会员无限聊：
- 💸 你的 API 成本会爆炸
- 😔 没有升级动力

#### 分级策略

| 会员类型 | AI 对话权限 |
|---------|------------|
| 季度会员 | ❌ 不可用（只能看开场白） |
| 年度会员 | ✅ 每期视频 15 次对话 |
| 永久会员 | 🔥 无限对话 + 3 种人格模式 |

#### 实现方式

```typescript
const limit = PERMISSIONS.aiChat.getLimit(membershipType);
const [messageCount, setMessageCount] = useState(0);

const handleSend = async () => {
  // 检查次数限制
  if (messageCount >= limit) {
    alert(`您已达到本期视频的对话次数上限（${limit}次）`);
    return;
  }

  // 发送消息
  await sendMessage();
  setMessageCount(prev => prev + 1);
};
```

#### 心理学技巧

**"冰激凌放在鼻子底下"**

季度会员能看到：
- ✅ 精美的对话界面
- ✅ Gabby 的开场白
- ✅ 输入框

但是：
- ❌ 点击发送 → 提示升级

→ 最强的转化动力！

---

### 6️⃣ 安全下载 API - 后端验证

**文件**：`app/api/download/route.ts`

**作用**：后端验证权限，防止前端绕过

#### 为什么需要？

前端的锁是"防君子不防小人"：
- 用户按 F12 删除遮罩层
- 在 Network 里抓包
- 修改前端代码

→ 可以绕过前端限制

#### 三层防护

```
第一层：前端 UI 锁
└─ 隐藏下载按钮

第二层：后端 API 验证
└─ 检查会员权限

第三层：OSS 签名 URL
└─ 临时链接，1 小时后失效
```

#### 实现方式

```typescript
// app/api/download/route.ts

export async function POST(request) {
  const { membershipType, lessonId } = await request.json();

  // 🔒 后端验证（用户无法绕过）
  if (!PERMISSIONS.download.canDownload(membershipType)) {
    return NextResponse.json(
      { error: '下载功能仅限永久会员' },
      { status: 403 }
    );
  }

  // 🔐 生成临时签名 URL（1 小时有效）
  const signedUrl = await generateSignedUrl(lessonId);
  
  return NextResponse.json({ 
    downloadUrl: signedUrl,
    expiresIn: 3600 
  });
}
```

#### 安全机制

1. **前端锁**：UI 层面隐藏下载按钮
2. **后端锁**：API 验证会员权限
3. **OSS 签名**：临时 URL，1 小时后失效
4. **日志记录**：记录下载行为，防滥用

---

## 快速上手

### 🧪 测试权限系统

#### 访问测试页面

```bash
# 启动开发服务器
npm run dev

# 在浏览器中访问
http://localhost:3000/test-permissions
```

**测试页面功能**：
- ✅ 视频访问权限矩阵（实时显示所有会员类型的权限）
- ✅ Gabby AI 配置对比（对话次数、人格模式等）
- ✅ 下载权限对比（笔记导出、原片下载）
- ✅ 会员权益对比表（完整的功能说明）

#### 配合开发者面板测试

1. 打开测试页面 `http://localhost:3000/test-permissions`
2. 点击右下角黑色圆形按钮（眼睛图标）
3. 输入密码：`456852`
4. 切换不同会员类型
5. 页面自动刷新，查看权限变化

---

### 🚀 开发环境

#### 1. 启动开发服务器

```bash
npm run dev
```

#### 2. 打开开发者面板

- 右下角黑色圆形按钮（眼睛图标）
- 输入密码：`456852`
- 选择会员类型测试

#### 3. 测试不同会员权限

**测试季度会员**：
- Daily 课程：✅ 可访问
- Cognitive 课程：⚠️ 只能看精选页
- Business 课程：🔒 磨砂玻璃遮罩
- Gabby AI：❌ 只能看开场白

**测试年度会员**：
- 所有课程：✅ 可访问
- Gabby AI：✅ 15 次/期
- 下载功能：❌ 不可用

**测试永久会员**：
- 所有功能：🔥 完全解锁

---

### 📝 添加新功能

#### 步骤 1：在"宪法"中添加规则

```typescript
// lib/permissions.ts
export const PERMISSIONS = {
  // ... 其他规则
  newFeature: {
    canAccess: (tier) => tier === '永久会员',
    description: '新功能说明'
  }
};
```

#### 步骤 2：在组件中使用

```typescript
import { PERMISSIONS } from '@/lib/permissions';

function NewFeatureComponent() {
  const membershipType = getMembershipType();
  const canUse = PERMISSIONS.newFeature.canAccess(membershipType);

  if (!canUse) {
    return <ContentGate requiredTier="lifetime" currentTier={membershipType} feature="新功能">
      <FeatureContent />
    </ContentGate>;
  }

  return <FeatureContent />;
}
```

---

### 🔧 修改权限规则

**场景**：产品经理说"季度会员也能用 AI 对话了"

**只需改一行代码**：

```typescript
// lib/permissions.ts
aiChat: {
  canAccess: (tier) => tier !== null, // 改这一行！
}
```

→ 全站自动生效！✨

---

## 常见问题

### Q1: 开发者面板在生产环境会显示吗？

**A**: 不会。开发者面板只在 `NODE_ENV === 'development'` 时显示，部署到 Vercel 后自动隐藏。

---

### Q2: 如何获取用户的会员类型？

**A**: 从 localStorage 读取（临时方案）：

```typescript
const membershipType = localStorage.getItem('membershipType') as MembershipTier;
```

生产环境应该从后端 API 获取真实会员状态。

---

### Q3: 如何防止用户绕过前端限制？

**A**: 使用三层防护：

1. **前端 UI 锁**：隐藏按钮/显示遮罩
2. **后端 API 验证**：检查会员权限
3. **OSS 签名 URL**：临时链接，防止直接访问

---

### Q4: 修改权限规则后需要重新部署吗？

**A**: 是的。权限规则在代码中，修改后需要：

```bash
git add .
git commit -m "更新权限规则"
git push
```

Vercel 会自动部署。

---

### Q5: 如何测试不同会员看到的界面？

**A**: 使用开发者面板：

1. 本地运行 `npm run dev`
2. 右下角眼睛图标 → 密码 `456852`
3. 切换会员类型 → 页面自动刷新

---

### Q6: AI 对话次数限制如何实现？

**A**: 在组件中记录次数：

```typescript
const limit = PERMISSIONS.aiChat.getLimit(membershipType);
const [messageCount, setMessageCount] = useState(0);

// 每次发送消息时检查
if (messageCount >= limit) {
  alert('已达上限');
  return;
}
```

注意：这是前端限制，生产环境应该在后端记录。

---

### Q7: 如何添加新的会员等级？

**A**: 

1. 修改类型定义：
```typescript
// lib/permissions.ts
export type MembershipTier = '季度会员' | '年度会员' | '永久会员' | '新等级' | null;
```

2. 更新权限规则：
```typescript
aiChat: {
  canAccess: (tier) => tier === '新等级' || tier === '年度会员' || tier === '永久会员'
}
```

3. 更新开发者面板：
```typescript
// components/DevPanel.tsx
const membershipTypes = [
  // ... 其他等级
  { id: "新等级", name: "新等级", icon: Star, color: "#ff0000" }
];
```

---

## 📚 相关文件

| 文件 | 作用 |
|------|------|
| `lib/permissions.ts` | 权限"宪法"，所有规则 |
| `components/DevPanel.tsx` | 开发者面板 |
| `components/ContentGate.tsx` | 门禁组件 |
| `components/ModuleSalon.tsx` | AI 对话限制 |
| `app/api/download/route.ts` | 安全下载 API |

---

## 🎯 核心原则

1. **DRY (Don't Repeat Yourself)** - 不要重复自己
2. **Single Source of Truth** - 单一数据源
3. **Defense in Depth** - 纵深防御（前端 + 后端）
4. **Graceful Degradation** - 优雅降级
5. **FOMO Marketing** - 让用户看到但得不到

---

## 📞 技术支持

如有问题，请检查：
1. 环境变量是否正确配置
2. 开发者面板是否能正常切换
3. 浏览器控制台是否有错误
4. 后端 API 是否正常响应

---

**记住**：权限系统是"宪法"，组件是"警察"，API 是"保险库"。三层防护，确保安全！🏛️

---

*最后更新：2026-02-18*

