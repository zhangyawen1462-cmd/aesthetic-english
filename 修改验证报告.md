# æœ¬æ¬¡å¯¹è¯ä¿®æ”¹éªŒè¯æŠ¥å‘Š

ç”Ÿæˆæ—¶é—´ï¼š2026-02-20

---

## âœ… å·²æˆåŠŸä¿å­˜çš„ä¿®æ”¹ï¼ˆ9é¡¹ï¼‰

### 1. AI æç¤ºè¯å‡çº§ä¸ºå­¦ä¹ å¯¼å‘ç‰ˆ âœ…
**æ–‡ä»¶**: `app/api/ai-chat-secure/route.ts`
- âœ… å›å¤é•¿åº¦ï¼š15ä¸ªè¯ â†’ 20-40ä¸ªè¯
- âœ… è¯æ±‡å¤ç”¨ï¼š1-2ä¸ª â†’ 2-3ä¸ª
- âœ… å¼€æ”¾å¼é—®é¢˜å¼•å¯¼
- âœ… åˆ›é€ å­¦ä¹ åœºæ™¯

### 2. æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶æå‡ âœ…
**æ–‡ä»¶**: `next.config.ts`
- âœ… bodySizeLimit: 2mb â†’ 100mb

### 3. éŸ³é¢‘æ ¼å¼æ”¹ä¸º MP3 âœ…
**æ–‡ä»¶**: `app/admin/publish/page.tsx`
- âœ… accept: audio/mpeg,audio/mp3,.mp3
- âœ… æ ‡ç­¾å’Œæç¤ºæ–‡å­—å·²æ›´æ–°

### 4. é•¿å­—å¹•åˆ†å—å­˜å‚¨ âœ…
**æ–‡ä»¶**: `app/api/publish/route.ts`
- âœ… SRT å­—å¹•åˆ†å—ï¼ˆæ¯ 2000 å­—ç¬¦ï¼‰
- âœ… Recall ä¸­æ–‡åˆ†å—
- âœ… Recall è‹±æ–‡åˆ†å—

### 5. DeepSeek max_tokens é™åˆ¶ âœ…
**æ–‡ä»¶**: `app/api/publish/route.ts`
- âœ… max_tokens: 8192ï¼ˆDeepSeek æœ€å¤§é™åˆ¶ï¼‰

### 6. Notion æ–‡æœ¬è¯»å–åˆå¹¶ âœ…
**æ–‡ä»¶**: `lib/notion-client.ts`
- âœ… getPlainText å‡½æ•°åˆå¹¶æ‰€æœ‰ rich_text å—
- âœ… ä½¿ç”¨ .join('') æ‹¼æ¥

### 7. AI ç”Ÿæˆå†…å®¹æ•°æ®éªŒè¯ âœ…
**æ–‡ä»¶**: `app/api/publish/route.ts`
- âœ… è¯æ±‡éªŒè¯ï¼šè·³è¿‡ä¸å®Œæ•´æ•°æ®
- âœ… è¯­æ³•éªŒè¯ï¼šè·³è¿‡ä¸å®Œæ•´æ•°æ®
- âœ… Recall éªŒè¯ï¼šç¡®ä¿ä¸­è‹±æ–‡éƒ½å­˜åœ¨

### 8. è®¢é˜…å¼¹çª—ç‚¹å‡»ç©ºç™½å…³é—­ âœ…
**æ–‡ä»¶**: `components/SubscriptionModal.tsx`
- âœ… èƒŒæ™¯å±‚æ·»åŠ  onClick={onClose}
- âœ… å†…å®¹å±‚æ·»åŠ  stopPropagation

### 9. åˆ é™¤ä¸´æ—¶æ–‡ä»¶ âœ…
- âœ… åˆ é™¤ docs/ æ–‡ä»¶å¤¹
- âœ… åˆ é™¤å­—ä½“æ–‡ä»¶å¤¹
- âœ… åˆ é™¤ .md æ–‡æ¡£
- âœ… åˆ é™¤ test-dashboard.js

---

## âŒ æœªä¿å­˜çš„ä¿®æ”¹ï¼ˆéœ€è¦é‡æ–°åº”ç”¨ï¼‰

### 1. AI æ¨¡å¼åç§°å’Œå›¾æ ‡ âŒ
**æ–‡ä»¶**: `components/ModuleSalon.tsx`
**å½“å‰çŠ¶æ€**: ä»ç„¶æ˜¯è‹±æ–‡åç§°
- âŒ The Partner â†’ åº”æ”¹ä¸º â˜•ï¸ é è°±æ­æ¡£
- âŒ The Critic â†’ åº”æ”¹ä¸º ğŸ¥ æ¯’èˆŒè€å‹
- âŒ The FlÃ¢neur â†’ åº”æ”¹ä¸º ğŸ¥‚ æµªæ¼«æ—…ä¼´

**éœ€è¦ä¿®æ”¹çš„ä»£ç **ï¼ˆçº¦ç¬¬ 40-60 è¡Œï¼‰ï¼š
```typescript
const AI_MODES = {
  professional: {
    name: 'é è°±æ­æ¡£',  // æ”¹è¿™é‡Œ
    icon: 'â˜•ï¸',        // æ”¹è¿™é‡Œ
    openingHook: (title: string) => `Train's delayed. Should we grab lunch or wait here?`,
    openingHookCn: (title: string) => `ç«è½¦æ™šç‚¹äº†ã€‚æˆ‘ä»¬è¦å»åƒåˆé¥­è¿˜æ˜¯åœ¨è¿™ç­‰ï¼Ÿ`
  },
  arrogant: {
    name: 'æ¯’èˆŒè€å‹',  // æ”¹è¿™é‡Œ
    icon: 'ğŸ¥',        // æ”¹è¿™é‡Œ
    openingHook: (title: string) => `This place? Overrated. I know a better spot. Coming?`,
    openingHookCn: (title: string) => `è¿™åœ°æ–¹ï¼Ÿè¢«é«˜ä¼°äº†ã€‚æˆ‘çŸ¥é“æ›´å¥½çš„åœ°æ–¹ã€‚æ¥å—ï¼Ÿ`
  },
  romantic: {
    name: 'æµªæ¼«æ—…ä¼´',  // æ”¹è¿™é‡Œ
    icon: 'ğŸ¥‚',        // æ”¹è¿™é‡Œ
    openingHook: (title: string) => `Wow, this sunset is unreal. Let's grab a drink. What do you want?`,
    openingHookCn: (title: string) => `å“‡ï¼Œè¿™æ—¥è½ç»äº†ã€‚æˆ‘ä»¬å»å–ä¸€æ¯å§ã€‚ä½ æƒ³å–ä»€ä¹ˆï¼Ÿ`
  }
};
```

### 2. å¼€å‘ç¯å¢ƒå®‰å…¨å¯†é’¥éªŒè¯ âŒ
**æ–‡ä»¶**: `app/api/ai-chat-secure/route.ts`
**å½“å‰çŠ¶æ€**: æ²¡æœ‰ x-dev-secret éªŒè¯

**éœ€è¦æ·»åŠ çš„ä»£ç **ï¼ˆçº¦ç¬¬ 51-60 è¡Œï¼‰ï¼š
```typescript
async function verifyMembership(req: NextRequest) {
  try {
    // ğŸ”§ å¼€å‘ç¯å¢ƒï¼šå…è®¸é€šè¿‡ header æ¨¡æ‹Ÿä¼šå‘˜èº«ä»½
    const devTier = req.headers.get('x-dev-tier');
    const devSecret = req.headers.get('x-dev-secret');  // æ·»åŠ è¿™è¡Œ
    const isDev = process.env.NODE_ENV === 'development';
    const validDevSecret = process.env.DEV_SECRET || 'dev-only-secret-12345';  // æ·»åŠ è¿™è¡Œ
    
    if (isDev && devTier && devSecret === validDevSecret) {  // ä¿®æ”¹è¿™è¡Œ
      console.log('ğŸ”§ Dev mode: Using simulated tier:', devTier);
      return {
        valid: true,
        tier: devTier,
        userId: 'dev_user_fixed',
        deviceId: 'dev_device'
      };
    }
    
    // ... å…¶ä»–ä»£ç 
  }
}
```

### 3. å‰ç«¯å‘é€å¼€å‘å¯†é’¥ âŒ
**æ–‡ä»¶**: `components/ModuleSalon.tsx`
**å½“å‰çŠ¶æ€**: æ²¡æœ‰å‘é€ x-dev-secret

**éœ€è¦ä¿®æ”¹çš„ä»£ç **ï¼ˆçº¦ç¬¬ 117 è¡Œå’Œ 351 è¡Œï¼‰ï¼š
```typescript
// ç¬¬ä¸€å¤„ï¼šè·å–èŠå¤©æ¬¡æ•°æ—¶
const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
if (isDev && membershipType) {
  headers['x-dev-tier'] = membershipType;
  headers['x-dev-secret'] = 'dev-only-secret-12345';  // æ·»åŠ è¿™è¡Œ
}

// ç¬¬äºŒå¤„ï¼šå‘é€æ¶ˆæ¯æ—¶
const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
if (isDev && membershipType) {
  headers['x-dev-tier'] = membershipType;
  headers['x-dev-secret'] = 'dev-only-secret-12345';  // æ·»åŠ è¿™è¡Œ
}

// ç¬¬ä¸‰å¤„ï¼šç”Ÿæˆå¼€åœºç™½æ—¶ï¼ˆçº¦ç¬¬ 180 è¡Œï¼‰
const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
if (isDev && membershipType) {
  headers['x-dev-tier'] = membershipType;
  headers['x-dev-secret'] = 'dev-only-secret-12345';  // æ·»åŠ è¿™è¡Œ
}
```

### 4. é¦–é¡µé‚®ç®±åœ°å€ âŒ
**æ–‡ä»¶**: `app/page.tsx`
**å½“å‰çŠ¶æ€**: å¯èƒ½è¿˜æ˜¯æ—§é‚®ç®±

**éœ€è¦æ£€æŸ¥å¹¶ä¿®æ”¹**ï¼š
```tsx
<a
  href="mailto:aestheticenglish@outlook.com"
  className="text-[9px] tracking-[0.1em] text-[#2D0F15]/35 hover:text-[#2D0F15]/70 transition-colors"
>
  aestheticenglish@outlook.com
</a>
```

### 5. æ¨¡å¼é€‰æ‹©å™¨å®½åº¦ âŒ
**æ–‡ä»¶**: `components/ModuleSalon.tsx`
**å½“å‰çŠ¶æ€**: å¯èƒ½è¿˜æ˜¯ w-64 (256px)

**éœ€è¦ä¿®æ”¹**ï¼ˆçº¦ç¬¬ 475 è¡Œï¼‰ï¼š
```tsx
<motion.div
  className="absolute right-0 top-full mt-2 rounded-xl border shadow-xl overflow-hidden z-30"
  style={{ 
    width: '150px',  // æ”¹ä¸º 150px
    backgroundColor: theme.background,
    borderColor: theme.lineColor
  }}
>
```

### 6. æ˜¾ç¤ºæ–‡å­—ä¼˜åŒ– âŒ
**æ–‡ä»¶**: `components/ModuleSalon.tsx`
**å½“å‰çŠ¶æ€**: éœ€è¦æ£€æŸ¥

**éœ€è¦ä¿®æ”¹**ï¼ˆçº¦ç¬¬ 730 è¡Œï¼‰ï¼š
```tsx
{hasAccess && dailyLimit !== Infinity && (
  <p className="text-[9px] uppercase tracking-widest opacity-40" style={{ color: theme.text }}>
    {hasReachedLimit 
      ? `å·²ç”¨å®Œæœ¬æœŸ ${dailyLimit} æ¬¡å¯¹è¯ â€¢ å‡çº§åˆ°æ°¸ä¹…ä¼šå‘˜å¯æ— é™å¯¹è¯` 
      : `å‰©ä½™ ${remainingChats}/${dailyLimit} æ¬¡å¯¹è¯ â€¢ æ°¸ä¹…ä¼šå‘˜å¯åˆ‡æ¢æ¨¡å¼`  // æ·»åŠ ååŠå¥
    }
  </p>
)}
```

### 7. SubscriptionModal ç§»åŠ¨ç«¯ä¼˜åŒ– âŒ
**æ–‡ä»¶**: `components/SubscriptionModal.tsx`
**å½“å‰çŠ¶æ€**: éœ€è¦æ£€æŸ¥

**éœ€è¦çš„ä¿®æ”¹**ï¼š
- åˆ é™¤ç§»åŠ¨ç«¯æ ‡é¢˜"ç¾å­¦è‹±è¯­ å‡­é‚€å…¥å†…"
- åˆ é™¤ç§»åŠ¨ç«¯èƒŒé¢çš„æœç´¢å›¾æ ‡å’Œ Return æŒ‰é’®
- èƒŒé¢æ ‡é¢˜æ”¹ä¸º"è¯šæŒšé‚€è¯·"ï¼ˆfont-sansï¼Œæ— æ–œä½“ï¼‰
- åˆ é™¤"æˆ‘ä»¬çš„å¯†é’¥ä»…é€šè¿‡..."æ–‡å­—ï¼ˆä»…ç§»åŠ¨ç«¯ï¼‰

### 8. ç§»åŠ¨ç«¯å¯¼å‡ºåŠŸèƒ½ç¦ç”¨ âŒ
**æ–‡ä»¶**: `app/[locale]/lesson/[id]/page.tsx`
**å½“å‰çŠ¶æ€**: éœ€è¦æ£€æŸ¥

**éœ€è¦æ³¨é‡Šæ‰ç§»åŠ¨ç«¯å¯¼å‡ºæŒ‰é’®**

---

## ğŸ¯ ä¼˜å…ˆçº§å»ºè®®

### é«˜ä¼˜å…ˆçº§ï¼ˆå½±å“åŠŸèƒ½ï¼‰ï¼š
1. âš ï¸ **å¼€å‘ç¯å¢ƒå®‰å…¨å¯†é’¥** - é˜²æ­¢ç”Ÿäº§ç¯å¢ƒè¢«ç»•è¿‡
2. âš ï¸ **AI æ¨¡å¼åç§°** - ç”¨æˆ·ç•Œé¢æ˜¾ç¤º

### ä¸­ä¼˜å…ˆçº§ï¼ˆç”¨æˆ·ä½“éªŒï¼‰ï¼š
3. ğŸ“± **SubscriptionModal ç§»åŠ¨ç«¯ä¼˜åŒ–**
4. ğŸ“± **æ¨¡å¼é€‰æ‹©å™¨å®½åº¦**
5. ğŸ“± **æ˜¾ç¤ºæ–‡å­—ä¼˜åŒ–**

### ä½ä¼˜å…ˆçº§ï¼ˆç»†èŠ‚ä¼˜åŒ–ï¼‰ï¼š
6. ğŸ“§ **é¦–é¡µé‚®ç®±åœ°å€**
7. ğŸ“± **ç§»åŠ¨ç«¯å¯¼å‡ºç¦ç”¨**

---

## ğŸ”§ å¿«é€Ÿä¿®å¤å‘½ä»¤

```bash
# 1. æ£€æŸ¥å½“å‰ AI æ¨¡å¼åç§°
grep -n "name: 'The" components/ModuleSalon.tsx

# 2. æ£€æŸ¥æ˜¯å¦æœ‰å¼€å‘å¯†é’¥éªŒè¯
grep -n "x-dev-secret" app/api/ai-chat-secure/route.ts

# 3. æ£€æŸ¥é‚®ç®±åœ°å€
grep -n "aestheticenglish@outlook.com" app/page.tsx

# 4. æŸ¥çœ‹æ‰€æœ‰æœªæäº¤çš„ä¿®æ”¹
git status

# 5. æŸ¥çœ‹å…·ä½“çš„ä¿®æ”¹å†…å®¹
git diff components/ModuleSalon.tsx
git diff components/SubscriptionModal.tsx
```

---

## ğŸ“ æ€»ç»“

**å·²ä¿å­˜**: 9 é¡¹æ ¸å¿ƒåŠŸèƒ½ä¿®æ”¹ âœ…
**æœªä¿å­˜**: 8 é¡¹ç•Œé¢å’Œå®‰å…¨ä¼˜åŒ– âŒ

**å»ºè®®**: ä¼˜å…ˆä¿®å¤å¼€å‘ç¯å¢ƒå®‰å…¨å¯†é’¥å’Œ AI æ¨¡å¼åç§°ï¼Œç„¶åå†å¤„ç†å…¶ä»–ç•Œé¢ä¼˜åŒ–ã€‚

---

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
1. ä¿®å¤ AI æ¨¡å¼åç§°ï¼ˆâ˜•ï¸ é è°±æ­æ¡£ã€ğŸ¥ æ¯’èˆŒè€å‹ã€ğŸ¥‚ æµªæ¼«æ—…ä¼´ï¼‰
2. æ·»åŠ å¼€å‘ç¯å¢ƒå®‰å…¨å¯†é’¥éªŒè¯
3. æµ‹è¯•é•¿å­—å¹•ä¸Šä¼ å’Œ AI å¯¹è¯åŠŸèƒ½
4. æäº¤æ‰€æœ‰ä¿®æ”¹åˆ° Git

